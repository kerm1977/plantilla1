{% extends 'base.html' %}

{% block title %}{{ _('Editar Contacto') }}{% endblock %}

{% block head_content %}
<style>
    .fab-container-save {
        position: fixed;
        bottom: 70px;
        z-index: 1000;
        right: 20px;
    }

    .fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        text-decoration: none;
        border: none;
    }
    .fab-button:hover {
        transform: scale(1.05);
        filter: brightness(90%);
    }
    .fab-button-save {
        background-color: var(--bs-warning);
        color: var(--bs-dark);
    }

    .edit-avatar-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-color: var(--bs-warning) !important;
        border: 3px solid;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="p-4">
                <h2 class="text-center mb-4 text-warning">{{ _('Editar Contacto') }}</h2>
                
                <form method="POST" action="{{ url_for('contactos.editar_contacto', user_id=user.id) }}" enctype="multipart/form-data" id="editContactForm">
                    <p class="text-muted text-center">{{ _('Los campos marcados con * son obligatorios.') }}</p>

                    <div class="mb-3 text-center">
                        <label for="avatar" class="form-label d-block mb-2">{{ _('Avatar Actual') }}</label>
                        <img src="{{ avatar_url }}" alt="Avatar" class="img-thumbnail rounded-circle mb-3 edit-avatar-preview" id="currentAvatarPreview">
                        <label for="avatar" class="form-label mt-3">{{ _('Cambiar Avatar (Opcional)') }}</label>
                        <input class="form-control" type="file" id="avatar" name="avatar" accept="image/*">
                    </div>

                    <hr class="my-4" style="border-color: var(--bs-border-color);">

                    <!-- Campos del formulario -->
                    <div class="mb-3">
                        <label for="nombre" class="form-label">{{ _('Nombre *') }}</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" value="{{ user.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="primer_apellido" class="form-label">{{ _('Primer Apellido *') }}</label>
                        <input type="text" class="form-control" id="primer_apellido" name="primer_apellido" value="{{ user.primer_apellido }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="segundo_apellido" class="form-label">{{ _('Segundo Apellido') }}</label>
                        <input type="text" class="form-control" id="segundo_apellido" name="segundo_apellido" value="{{ user.segundo_apellido if user.segundo_apellido else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">{{ _('Nombre de Usuario *') }}</label>
                        <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">{{ _('Correo Electrónico *') }}</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">{{ _('Teléfono *') }}</label>
                        <input type="tel" class="form-control" id="telefono" name="telefono" value="{{ user.telefono }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefono_emergencia" class="form-label">{{ _('Teléfono de Emergencia') }}</label>
                        <input type="tel" class="form-control" id="telefono_emergencia" name="telefono_emergencia" value="{{ user.telefono_emergencia if user.telefono_emergencia else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="nombre_emergencia" class="form-label">{{ _('Nombre Contacto Emergencia') }}</label>
                        <input type="text" class="form-control" id="nombre_emergencia" name="nombre_emergencia" value="{{ user.nombre_emergencia if user.nombre_emergencia else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="empresa" class="form-label">{{ _('Empresa') }}</label>
                        <input type="text" class="form-control" id="empresa" name="empresa" value="{{ user.empresa if user.empresa else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="cedula" class="form-label">{{ _('Cédula') }}</label>
                        <input type="text" class="form-control" id="cedula" name="cedula" value="{{ user.cedula if user.cedula else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">{{ _('Provincia') }}</label>
                        <select class="form-select" id="direccion" name="direccion">
                            <option value="">{{ _('Seleccionar') }}</option>
                            {% for p in provincia_opciones %}<option value="{{ p }}" {% if p == user.direccion %}selected{% endif %}>{{ p }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_cumpleanos" class="form-label">{{ _('Fecha de Cumpleaños') }}</label>
                        <input type="date" class="form-control" id="fecha_cumpleanos" name="fecha_cumpleanos" value="{{ user.fecha_cumpleanos.strftime('%Y-%m-%d') if user.fecha_cumpleanos else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="tipo_sangre" class="form-label">{{ _('Tipo de Sangre') }}</label>
                        <select class="form-select" id="tipo_sangre" name="tipo_sangre">
                            {% for t in tipo_sangre_opciones %}<option value="{{ t }}" {% if t == user.tipo_sangre %}selected{% endif %}>{{ t }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="poliza" class="form-label">{{ _('Póliza') }}</label>
                        <input type="text" class="form-control" id="poliza" name="poliza" value="{{ user.poliza if user.poliza else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="aseguradora" class="form-label">{{ _('Aseguradora') }}</label>
                        <input type="text" class="form-control" id="aseguradora" name="aseguradora" value="{{ user.aseguradora if user.aseguradora else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="alergias" class="form-label">{{ _('Alergias') }}</label>
                        <textarea class="form-control" id="alergias" name="alergias" rows="3">{{ user.alergias if user.alergias else '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="enfermedades_cronicas" class="form-label">{{ _('Enfermedades Crónicas') }}</label>
                        <textarea class="form-control" id="enfermedades_cronicas" name="enfermedades_cronicas" rows="3">{{ user.enfermedades_cronicas if user.enfermedades_cronicas else '' }}</textarea>
                    </div>
                    
                    {% if logged_in_user_role == 'Superuser' %}
                    <div class="mb-3">
                        <label for="actividad" class="form-label">{{ _('Actividad') }}</label>
                        <select class="form-select" id="actividad" name="actividad">
                            {% for a in actividad_opciones %}<option value="{{ a }}" {% if a == user.actividad %}selected{% endif %}>{{ a }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="capacidad" class="form-label">{{ _('Capacidad') }}</label>
                        <select class="form-select" id="capacidad" name="capacidad">
                            {% for c in capacidad_opciones %}<option value="{{ c }}" {% if c == user.capacidad %}selected{% endif %}>{{ c }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="participacion" class="form-label">{{ _('Participación') }}</label>
                        <select class="form-select" id="participacion" name="participacion">
                           {% for p in participacion_opciones %}<option value="{{ p }}" {% if p == user.participacion %}selected{% endif %}>{{ p }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">{{ _('Rol del Usuario') }}</label>
                        <select class="form-select" id="role" name="role">
                            {% for r in role_opciones %}<option value="{{ r }}" {% if r == user.role %}selected{% endif %}>{{ r }}</option>{% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<div class="fab-container-save">
    <a href="#" class="fab-button fab-button-save" title="{{ _('Guardar Cambios') }}" onclick="document.getElementById('editContactForm').submit(); return false;">
        <i class="fas fa-save"></i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.getElementById('avatar');
    const preview = document.getElementById('currentAvatarPreview');
    avatarInput.addEventListener('change', function(event) {
        if (event.target.files && event.target.files[0]) {
            preview.src = URL.createObjectURL(event.target.files[0]);
        }
    });
});
</script>
{% endblock %}
